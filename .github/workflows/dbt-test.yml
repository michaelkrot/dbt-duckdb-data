name: dbt CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  dbt-ci:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # Checkout code
      # -----------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # -----------------------------
      # Cache dbt packages
      # -----------------------------
      - name: Cache dbt packages
        uses: actions/cache@v4
        with:
          path: dbt_packages
          key: dbt-${{ hashFiles('packages.yml') }}-${{ hashFiles('Dockerfile') }}

      # -----------------------------
      # Build the custom dbt Docker image
      # -----------------------------
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build dbt Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          load: true
          tags: dbt-project:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # -----------------------------
      # Create dbt profile for CI
      # -----------------------------
      - name: Create dbt profile for CI
        run: |
          mkdir -p ./data
          echo -e "duckdb_dbt_project:\n  target: ci\n  outputs:\n    ci:\n      type: duckdb\n      path: /app/data/ci_duckdb.db\n      threads: 4" > ./profiles.yml

      # -----------------------------
      # Run all dbt commands in a single container
      # -----------------------------
      - name: Run dbt CI
        run: |
          docker run --rm \
            -v $(pwd):/app \
            -w /app \
            -v ./profiles.yml:/app/profiles.yml \
            --entrypoint="" \
            dbt-project:latest \
            sh -c "
              set -e
              dbt debug --target ci
              dbt deps
              dbt test --target ci --fail-fast
              dbt run --target ci --fail-fast
            "
