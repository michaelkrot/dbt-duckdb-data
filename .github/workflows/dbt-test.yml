name: dbt CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  dbt-ci:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # -----------------------------
      # Cache dbt packages + profiles
      # -----------------------------
      - name: Cache dbt packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.dbt
            dbt_packages
          key: dbt-${{ hashFiles('packages.yml') }}

      # -----------------------------
      # Docker build with layer cache
      # -----------------------------
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build dbt Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          load: true
          tags: dbt-project
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # -----------------------------
      # Create dbt profile for CI
      # -----------------------------
      - name: Create dbt profile
        run: |
          mkdir -p ~/.dbt
          cat > ~/.dbt/profiles.yml << 'EOF'
          duckdb_dbt_project:
            target: ci
            outputs:
              ci:
                type: duckdb
                path: /app/data/ci_duckdb.db
                threads: 4
          EOF

      # -----------------------------
      # Run dbt (single container)
      # -----------------------------
      - name: Run dbt CI
        run: |
          docker run --rm \
            -v $(pwd):/app \
            -v ~/.dbt:/root/.dbt \
            -w /app \
            dbt-project \
            bash -c "
              dbt debug --target ci &&
              dbt deps &&
              dbt build --target ci --fail-fast
            "
